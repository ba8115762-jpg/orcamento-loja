<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Or√ßamento Profissional</title>
  <meta name="description" content="Calcula m¬≤ por ambiente, soma, gera or√ßamento visual e envia por WhatsApp" />
  <style>
    :root{
      --bg:#071023; --card:#07172b; --panel:#0b2233; --accent:#06b6d4; --accent-2:#7c3aed; --muted:#9fb3c8; --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:linear-gradient(180deg,#031026 0%, #061229 60%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}

    .wrap{width:1100px;max-width:96%;display:grid;grid-template-columns:420px 1fr;gap:20px}
    .panel{background:linear-gradient(180deg,var(--card),#031228);border-radius:var(--radius);padding:18px;box-shadow:0 8px 40px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}

    h1{font-size:18px;margin:0 0 8px 0;display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:13px}

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;font-size:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .env-list{display:flex;flex-direction:column;gap:10px;max-height:320px;overflow:auto;padding-right:6px;margin-top:8px}
    .env{display:flex;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));align-items:center}
    .env .meta{flex:1}
    .env .meta small{display:block;color:var(--muted);font-size:12px}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;color:white;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .btn.small{padding:6px 10px;font-size:12px}

    .preview{padding:20px;min-height:540px;overflow:auto}
    .invoice{background:linear-gradient(180deg,#e9f6fb,#f6fbff);color:#071726;padding:18px;border-radius:12px;border:1px solid rgba(2,6,23,0.06);min-width:320px}

    .invoice header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:66px;height:66px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:white;overflow:hidden;position:relative}
    .logo img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .companyTitle{font-weight:800}
    .companyMeta{font-size:13px;color:#254254}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:white}
    th,td{padding:10px;text-align:left;border-bottom:1px dashed rgba(0,0,0,0.06);font-size:13px}
    th{color:#355a70;background:#f1f7fb;font-weight:700}
    td.right{text-align:right}

    .total{display:flex;justify-content:flex-end;margin-top:14px;font-weight:700}
    .images-row{display:flex;gap:10px;margin-top:12px}
    .thumb{width:96px;height:64px;border-radius:8px;background:#eef7fb;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(0,0,0,0.06)}
    .small{font-size:12px;color:#5f7c8a}

    footer.app-actions{display:flex;gap:10px;justify-content:space-between;margin-top:12px}

    /* Modal para o Link */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);padding:30px;border-radius:20px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1)}
    .link-display{background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin:15px 0;word-break:break-all;border:1px solid var(--accent)}

    /* Configura√ß√£o do Logo */
    .logo-config{background:rgba(255,255,255,0.02);padding:15px;border-radius:10px;margin-bottom:15px;border:1px dashed rgba(255,255,255,0.1)}
    
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>üîß Sistema de Or√ßamento <span class="muted">(m¬≤ por ambiente)</span></h1>
      <p class="muted">Adicione ambientes com largura x comprimento (m). O sistema calcula m¬≤, totaliza, gera preview estilizado e envia por WhatsApp.</p>

      <!-- CONFIGURA√á√ÉO DO LOGO -->
      <div class="logo-config">
        <label><strong>üì∑ Logo da Sua Empresa</strong></label>
        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <div class="logo">
            <img id="logoImg" src="" alt="Logo" style="display:none"/>
            <div id="logoPlaceholder" style="font-size:12px;text-align:center">Seu Logo</div>
          </div>
          <div style="flex:1">
            <label class="btn ghost" style="width:100%;text-align:center;margin-bottom:5px">
              üìÅ Escolher Logo
              <input id="uploadCompanyLogo" type="file" accept="image/*" style="display:none"/>
            </label>
            <button id="removeLogo" class="btn danger small" style="width:100%;display:none">
              üóëÔ∏è Remover Logo
            </button>
            <div class="muted" style="font-size:11px;margin-top:5px">PNG, JPG at√© 2MB</div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Nome da Loja</label>
        <input id="companyName" type="text" placeholder="Ex: Gesso Lucca - Especialistas" />
        <div class="row" style="margin-top:8px;">
          <input id="companyPhone" type="text" placeholder="Telefone da loja" value="(11) 97777-7777" />
          <input id="companyAddress" type="text" placeholder="Endere√ßo da loja" value="Rua Zambueng, 4362" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Dados do Cliente</label>
        <div class="row" style="margin-top:8px;">
          <input id="clientName" type="text" placeholder="Nome do cliente" value="Zimkau!" />
          <input id="clientPhone" type="text" placeholder="Telefone do cliente" value="(11) 93333-3333" />
        </div>
        <input id="clientAddress" type="text" placeholder="Endere√ßo do cliente" style="margin-top:8px;" value="Rua Dezesseis, 16" />
        
        <!-- CAMPO DE DATA ADICIONADO AQUI -->
        <div style="margin-top:12px">
          <label>Data do Or√ßamento</label>
          <input id="budgetDate" type="date" style="margin-top:8px;" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Valor por m¬≤ (R$)</label>
        <input id="unitPrice" type="number" step="0.01" placeholder="Ex: 150.00" value="85.00" />
      </div>

      <div style="margin-top:12px">
        <label>Tipo de servi√ßo</label>
        <select id="serviceType">
          <option>Instala√ß√£o de gesso</option>
          <option>Acabamento simples</option>
          <option>Piso e azulejo</option>
          <option>Pintura</option>
          <option>Reforma completa</option>
          <option>Outro</option>
        </select>
        <input id="serviceNote" type="text" placeholder="Observa√ß√£o sobre o servi√ßo (opcional)" style="margin-top:8px;" />
      </div>

      <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.04);margin:14px 0" />

      <div>
        <label><strong>Adicionar Ambiente</strong></label>
        <div class="row">
          <select id="envType">
            <option>Quarto</option>
            <option>Sala</option>
            <option>Cozinha</option>
            <option>Banheiro</option>
            <option>Corredor</option>
            <option>Outro</option>
          </select>
          <input id="envName" type="text" placeholder="Nome (ex: Quarto 1)" />
        </div>
        <div class="row" style="margin-top:8px">
          <input id="envWidth" type="number" step="0.01" placeholder="Largura (m)" />
          <input id="envLength" type="number" step="0.01" placeholder="Comprimento (m)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <button id="addEnv" class="btn">‚ûï Adicionar ambiente</button>
          <button id="clearAll" class="btn ghost">Limpar tudo</button>
        </div>

        <div id="envList" class="env-list"></div>
      </div>

    </div>

    <div class="panel preview">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <strong>Pr√©-visualiza√ß√£o do Or√ßamento</strong>
          <div class="small">Visual moderno ‚Äî gere PNG para enviar ao cliente ou use Whatsapp direto.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="genPNG" class="btn ghost">‚¨áÔ∏è Gerar PNG</button>
          <button id="sendWA" class="btn">üì≤ Enviar por WhatsApp</button>
          <button id="genLink" class="btn" style="background:linear-gradient(90deg,#10b981,#059669)">üîó Gerar Link</button>
        </div>
      </div>

      <div id="invoice" class="invoice">
        <header>
          <div class="brand">
            <div class="logo" id="logoArea">
              <img id="previewLogoImg" src="" alt="logo" style="display:none"/>
              <div id="previewLogoPlaceholder" style="font-size:12px;text-align:center">Logo</div>
            </div>
            <div>
              <div class="companyTitle" id="companyTitle">Gesso Lucca</div>
              <div class="companyMeta" id="companyMeta">(11) 97777-7777 ‚Ä¢ Rua Zambueng, 4362</div>
            </div>
          </div>
          <div style="text-align:right">
            <div class="small">Or√ßamento</div>
            <div id="dateNow" style="font-weight:700">22/11/2025</div>
          </div>
        </header>

        <div style="display:flex;justify-content:space-between;gap:20px;align-items:flex-start">
          <div>
            <div class="small">Cliente</div>
            <div id="clientTitle" style="font-weight:700">Zimkau!</div>
            <div class="companyMeta" id="clientMeta">(11) 93333-3333 ‚Ä¢ Rua Dezesseis, 16</div>
          </div>

          <div style="text-align:right">
            <div class="small">Servi√ßo</div>
            <div id="serviceTitle" style="font-weight:700">Instala√ß√£o de gesso</div>
            <div class="small" id="serviceNotePreview"></div>
          </div>
        </div>

        <table id="itemsTable" aria-live="polite">
          <thead>
            <tr><th>Ambiente</th><th style="width:90px">m¬≤</th><th style="width:140px">Valor/m¬≤</th><th style="width:140px">Subtotal (R$)</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="total">
          <div style="min-width:300px;">
            <div class="small">Total m¬≤: <span id="totalM2">0</span></div>
            <div class="small">Valor total (R$): <span id="totalValue">0,00</span></div>
          </div>
        </div>

        <div class="images-row" id="imagesRow"></div>

        <div style="margin-top:12px;font-size:13px;color:#37576b">Observa√ß√µes gerais: <span id="notesPreview">‚Äî</span></div>
        
        <!-- DATA NO RODAP√â DO OR√áAMENTO -->
        <div style="margin-top:20px;padding-top:10px;border-top:1px dashed #ccc;text-align:center;font-size:12px;color:#5f7c8a">
       sistema criado por :  (Bruno arujo bonifacio )        Data de emiss√£o: <span id="invoiceDate">22/11/2025 </span>
        </div>
      </div>

      <footer class="app-actions">
        <div style="display:flex;gap:8px">
          <label class="btn ghost">üñºÔ∏è Imagens do servi√ßo <input id="uploadImage" type="file" accept="image/*" style="display:none" multiple /></label>
        </div>
        <div style="display:flex;gap:8px">
          <button id="copySummary" class="btn ghost">üìã Copiar Texto</button>
          <button id="downloadJSON" class="btn ghost">üíæ Exportar JSON</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal para mostrar o link -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <h2>üîó Link do Or√ßamento</h2>
      <p class="muted">Envie este link para seu cliente visualizar o or√ßamento:</p>
      
      <div class="link-display" id="generatedLink">
        Carregando...
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px">
        <button class="btn" onclick="copyGeneratedLink()" style="flex:1">üìã Copiar Link</button>
        <button class="btn ghost" onclick="closeLinkModal()" style="flex:1">Fechar</button>
      </div>
      
      <div style="margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px">
        <small class="muted">üí° Dica: Este link funciona mesmo ap√≥s fechar a p√°gina. Salve no seu sistema para acesso futuro.</small>
      </div>
    </div>
  </div>

  <script>
    // --- Data model ---
    const model = {envs:[], images:[], logo: null};
    const $ = id => document.getElementById(id);
    const fmt = v => Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    // FUN√á√ÉO PARA INICIALIZAR DATA
    function initializeDate() {
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0]; // Formato YYYY-MM-DD
      const displayDate = today.toLocaleDateString('pt-BR'); // Formato DD/MM/AAAA
      
      // Definir data atual no campo
      $('budgetDate').value = formattedDate;
      
      // Atualizar display da data
      $('dateNow').textContent = displayDate;
      $('invoiceDate').textContent = displayDate;
    }

    // init
    initializeDate();

    // Carregar logo salvo do localStorage
    function loadSavedLogo() {
      const savedLogo = localStorage.getItem('companyLogo');
      if (savedLogo) {
        model.logo = savedLogo;
        updateLogoDisplay();
      }
    }

    // Atualizar exibi√ß√£o do logo em todos os lugares
    function updateLogoDisplay() {
      if (model.logo) {
        // No sistema
        $('logoImg').src = model.logo;
        $('logoImg').style.display = 'block';
        $('logoPlaceholder').style.display = 'none';
        $('removeLogo').style.display = 'block';
        
        // Na pr√©-visualiza√ß√£o
        $('previewLogoImg').src = model.logo;
        $('previewLogoImg').style.display = 'block';
        $('previewLogoPlaceholder').style.display = 'none';
      } else {
        // Sem logo - mostrar placeholders
        $('logoImg').style.display = 'none';
        $('logoPlaceholder').style.display = 'block';
        $('removeLogo').style.display = 'none';
        
        $('previewLogoImg').style.display = 'none';
        $('previewLogoPlaceholder').style.display = 'block';
      }
    }

    // Upload do Logo
    $('uploadCompanyLogo').addEventListener('change', function(ev) {
      const file = ev.target.files[0];
      if (!file) return;
      
      // Verificar tamanho do arquivo (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('‚ö†Ô∏è Arquivo muito grande! Escolha uma imagem menor que 2MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        model.logo = e.target.result;
        
        // Salvar no localStorage para sess√µes futuras
        localStorage.setItem('companyLogo', model.logo);
        
        // Atualizar a exibi√ß√£o
        updateLogoDisplay();
      };
      reader.readAsDataURL(file);
      ev.target.value = '';
    });

    // Remover Logo
    $('removeLogo').addEventListener('click', function() {
      if (confirm('Tem certeza que deseja remover o logo?')) {
        model.logo = null;
        localStorage.removeItem('companyLogo');
        updateLogoDisplay();
      }
    });

    // Adicionar alguns ambientes de exemplo
    setTimeout(() => {
      model.envs = [
        {type: "Quarto", name: "Quarto 1", w: 3.5, l: 2.5, service: "Instala√ß√£o de gesso"},
        {type: "Sala", name: "Sala", w: 4.3, l: 3.5, service: "Instala√ß√£o de gesso"},
        {type: "Cozinha", name: "Cozinha", w: 4.0, l: 4.0, service: "Instala√ß√£o de gesso"},
        {type: "Banheiro", name: "Banheiro", w: 2.8, l: 1.6, service: "Instala√ß√£o de gesso"},
        {type: "Corredor", name: "Corredor 5", w: 5.0, l: 0.9, service: "Instala√ß√£o de gesso"}
      ];
      renderEnvList(); 
      syncPreview();
      loadSavedLogo(); // Carregar logo salvo
    }, 100);

    function renderEnvList(){
      const list = $('envList'); list.innerHTML='';
      model.envs.forEach((e,idx)=>{
        const el = document.createElement('div'); el.className='env';
        el.innerHTML = `
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>${e.name} (${e.type})</strong>
              <div class="small">${(e.w*e.l).toFixed(2)} m¬≤</div>
            </div>
            <small>L:${e.w}m ‚Ä¢ C:${e.l}m ‚Ä¢ Servi√ßo: ${e.service||'‚Äî'}</small>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="btn ghost" onclick="editEnv(${idx})">‚úèÔ∏è</button>
            <button class="btn" onclick="removeEnv(${idx})">üóëÔ∏è</button>
          </div>`;
        list.appendChild(el);
      });
    }

    function syncPreview(){
      $('companyTitle').innerText = $('companyName').value || 'Nome da Loja';
      $('companyMeta').innerText = `${$('companyPhone').value || '‚Äî'} ‚Ä¢ ${$('companyAddress').value || '‚Äî'}`;
      $('clientTitle').innerText = $('clientName').value || 'Nome do cliente';
      $('clientMeta').innerText = `${$('clientPhone').value || '‚Äî'} ‚Ä¢ ${$('clientAddress').value || '‚Äî'}`;
      $('serviceTitle').innerText = $('serviceType').value;
      $('serviceNotePreview').innerText = $('serviceNote').value || '';
      $('notesPreview').innerText = $('serviceNote').value || '‚Äî';

      // ATUALIZAR DATA NA PR√â-VISUALIZA√á√ÉO
      const selectedDate = new Date($('budgetDate').value);
      const displayDate = selectedDate.toLocaleDateString('pt-BR');
      $('dateNow').textContent = displayDate;
      $('invoiceDate').textContent = displayDate;

      const tbody = $('itemsTable').querySelector('tbody'); tbody.innerHTML='';
      const unit = parseFloat($('unitPrice').value) || 0;
      let totalM2 = 0, totalVal = 0;
      model.envs.forEach((e,idx)=>{
        const m2 = (Number(e.w||0)*Number(e.l||0));
        const sub = m2*unit;
        totalM2 += m2; totalVal += sub;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.name} ‚Äî ${e.type}</td><td>${m2.toFixed(2)}</td><td>R$ ${fmt(unit)}</td><td>R$ ${fmt(sub)}</td>`;
        tbody.appendChild(tr);
      });
      $('totalM2').innerText = totalM2.toFixed(2);
      $('totalValue').innerText = fmt(totalVal);

      // images
      const imagesRow = $('imagesRow'); imagesRow.innerHTML='';
      (model.images||[]).forEach((src, i)=>{
        const d = document.createElement('div'); d.className='thumb'; d.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover"/>`;
        imagesRow.appendChild(d);
      });
    }

    // add env
    $('addEnv').addEventListener('click', ()=>{
      const type = $('envType').value;
      const name = $('envName').value || `${type} ${model.envs.length+1}`;
      const w = parseFloat($('envWidth').value);
      const l = parseFloat($('envLength').value);
      if(isNaN(w) || isNaN(l)) return alert('Preencha largura e comprimento v√°lidos (em metros).');
      const service = $('serviceType').value;
      model.envs.push({type,name,w,l,service});
      $('envName').value=''; $('envWidth').value=''; $('envLength').value='';
      renderEnvList(); syncPreview();
    });

    function removeEnv(i){ if(!confirm('Remover ambiente?')) return; model.envs.splice(i,1); renderEnvList(); syncPreview(); }
    function editEnv(i){
      const e = model.envs[i];
      const name = prompt('Nome do ambiente:', e.name); if(name===null) return;
      const w = parseFloat(prompt('Largura (m):', e.w)); if(isNaN(w)) return alert('Largura inv√°lida');
      const l = parseFloat(prompt('Comprimento (m):', e.l)); if(isNaN(l)) return alert('Comprimento inv√°lido');
      model.envs[i] = {...e, name, w, l}; renderEnvList(); syncPreview();
    }

    $('clearAll').addEventListener('click', ()=>{ if(confirm('Limpar todos os dados?')){ model.envs=[]; model.images=[]; $('companyName').value=''; $('clientName').value=''; $('clientPhone').value=''; $('clientAddress').value=''; $('companyPhone').value=''; $('companyAddress').value=''; $('unitPrice').value=''; $('serviceNote').value=''; renderEnvList(); syncPreview(); } });

    ['companyName','companyPhone','companyAddress','clientName','clientPhone','clientAddress','unitPrice','serviceType','serviceNote','budgetDate'].forEach(id=>{ $(id).addEventListener('input',syncPreview); });

    // images upload
    $('uploadImage').addEventListener('change', (ev)=>{
      const files = Array.from(ev.target.files);
      model.images = model.images || [];
      files.forEach(f=>{
        const reader = new FileReader();
        reader.onload = e => { model.images.push(e.target.result); syncPreview(); }
        reader.readAsDataURL(f);
      });
      ev.target.value='';
    });

    // copy summary
    $('copySummary').addEventListener('click', ()=>{ 
      const selectedDate = new Date($('budgetDate').value);
      const displayDate = selectedDate.toLocaleDateString('pt-BR');
      
      const txt = buildTextSummary();
      navigator.clipboard.writeText(txt).then(()=>alert('Resumo copiado para a √°rea de transfer√™ncia')); 
    });
    
    $('downloadJSON').addEventListener('click', ()=>{ 
      const data = JSON.stringify({
        company: $('companyName').value, 
        client: $('clientName').value, 
        date: new Date($('budgetDate').value).toLocaleDateString('pt-BR'),
        model
      }, null, 2); 
      const blob = new Blob([data],{type:'application/json'}); 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href=url; 
      a.download='orcamento.json'; 
      a.click(); 
      URL.revokeObjectURL(url); 
    });

    function buildTextSummary(){
      const unit = Number($('unitPrice').value||0);
      const selectedDate = new Date($('budgetDate').value);
      const displayDate = selectedDate.toLocaleDateString('pt-BR');
      
      let lines = [];
      lines.push(`${$('companyName').value || 'Loja'} ‚Äî Or√ßamento`);
      lines.push(`Data: ${displayDate}`);
      lines.push(`Cliente: ${$('clientName').value || '-'} | Tel: ${$('clientPhone').value || '-'}`);
      lines.push(`End.: ${$('clientAddress').value || '-'}`);
      lines.push(`Servi√ßo: ${$('serviceType').value} ${$('serviceNote').value?'- '+$('serviceNote').value:''}`);
      lines.push('Ambientes:');
      let totalM2=0,total=0;
      model.envs.forEach(e=>{
        const m2 = Number(e.w)*Number(e.l); const sub = m2*unit; totalM2+=m2; total+=sub;
        lines.push(`- ${e.name} (${e.type}): ${m2.toFixed(2)} m¬≤ x R$ ${unit.toFixed(2)} = R$ ${sub.toFixed(2)}`);
      });
      lines.push(`Total m¬≤: ${totalM2.toFixed(2)} m¬≤`);
      lines.push(`Valor total: R$ ${total.toFixed(2)}`);
      lines.push('Atenciosamente,');
      lines.push(`${$('companyName').value || '-'} | ${$('companyPhone').value || '-'}`);
      return lines.join('\n');
    }

    // WhatsApp
    $('sendWA').addEventListener('click', ()=>{
      const phone = prompt('N√∫mero do WhatsApp destino (ex: 5511999998888) ‚Äî deixe em branco para abrir WhatsApp Web', $('clientPhone').value||'');
      const text = buildTextSummary();
      const url = `https://wa.me/${phone || ''}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
    });

    // Generate PNG
    $('genPNG').addEventListener('click', async ()=>{
      if(typeof html2canvas === 'undefined'){
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.body.appendChild(s);
        s.onload = () => capture();
      } else capture();
      function capture(){
        const node = document.getElementById('invoice');
        html2canvas(node, {scale:2}).then(canvas=>{
          canvas.toBlob(blob=>{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'orcamento.png'; a.click(); URL.revokeObjectURL(url);
          }, 'image/png');
        });
      }
    });

    // ========== FUNCIONALIDADE: GERAR LINK ==========
    
    // Modal functions
    function showLinkModal() {
      $('linkModal').style.display = 'flex';
    }
    
    function closeLinkModal() {
      $('linkModal').style.display = 'none';
    }
    
    function copyGeneratedLink() {
      const linkText = $('generatedLink').textContent;
      navigator.clipboard.writeText(linkText).then(() => {
        alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
      });
    }

    // Gerar Link do Or√ßamento
    $('genLink').addEventListener('click', generateShareableLink);

    function generateShareableLink() {
      const selectedDate = new Date($('budgetDate').value);
      const displayDate = selectedDate.toLocaleDateString('pt-BR');
      
      // Coletar todos os dados do or√ßamento
      const budgetData = {
        company: {
          name: $('companyName').value,
          phone: $('companyPhone').value,
          address: $('companyAddress').value
        },
        client: {
          name: $('clientName').value,
          phone: $('clientPhone').value,
          address: $('clientAddress').value
        },
        service: {
          type: $('serviceType').value,
          note: $('serviceNote').value
        },
        unitPrice: parseFloat($('unitPrice').value) || 0,
        envs: model.envs,
        logo: model.logo,
        date: displayDate // USAR A DATA SELECIONADA
      };

      // Codificar os dados em base64 para URL
      const jsonString = JSON.stringify(budgetData);
      const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
      
      // Gerar URL (em produ√ß√£o, isso seria seu dom√≠nio no Render/Vercel)
      const baseUrl = window.location.href.split('?')[0]; // Remove par√¢metros existentes
      const shareableUrl = `${baseUrl}?view=budget&data=${base64Data}`;
      
      // Mostrar o link no modal
      $('generatedLink').textContent = shareableUrl;
      showLinkModal();
    }

    // Verificar se deve mostrar a visualiza√ß√£o do or√ßamento
    function checkViewMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const viewMode = urlParams.get('view');
      const dataParam = urlParams.get('data');
      
      if (viewMode === 'budget' && dataParam) {
        showBudgetView(dataParam);
        return true;
      }
      return false;
    }

    // Mostrar visualiza√ß√£o do or√ßamento (para o cliente)
    function showBudgetView(base64Data) {
      try {
        // Decodificar dados
        const jsonString = decodeURIComponent(escape(atob(base64Data)));
        const budgetData = JSON.parse(jsonString);
        
        // Esconder o sistema de edi√ß√£o
        document.querySelector('.wrap').style.display = 'none';
        
        // Criar visualiza√ß√£o para o cliente
        createClientView(budgetData);
        
      } catch (e) {
        document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: white;">Erro ao carregar o or√ßamento</div>';
      }
    }

    function createClientView(data) {
      // Calcular totais
      let totalM2 = 0;
      let totalValue = 0;
      data.envs.forEach(env => {
        const m2 = env.w * env.l;
        totalM2 += m2;
        totalValue += m2 * data.unitPrice;
      });

      // Criar HTML da visualiza√ß√£o do cliente
      document.body.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px; background: white; min-height: 100vh;">
          <header style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
              ${data.logo ? 
                `<img src="${data.logo}" alt="Logo" style="width: 80px; height: 80px; border-radius: 10px; border: 3px solid white;">` : 
                `<div style="width: 80px; height: 80px; border-radius: 10px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; border: 3px solid white;">
                  <span style="font-size: 12px; text-align: center;">Logo</span>
                </div>`
              }
              <div>
                <h1 style="margin: 0; font-size: 24px;">${data.company.name}</h1>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">${data.company.phone} ‚Ä¢ ${data.company.address}</p>
              </div>
            </div>
            <h2 style="margin: 10px 0 5px 0;">üìã Or√ßamento</h2>
            <p style="margin: 0;"><strong>${data.date}</strong></p>
          </header>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <h3 style="margin-top: 0;">üë§ Cliente</h3>
              <p><strong>${data.client.name}</strong></p>
              <p>${data.client.phone}</p>
              <p>${data.client.address}</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <h3 style="margin-top: 0;">üîß Servi√ßo</h3>
              <p><strong>${data.service.type}</strong></p>
              ${data.service.note ? `<p>${data.service.note}</p>` : ''}
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <thead>
              <tr style="background: #2c3e50; color: white;">
                <th style="padding: 12px; text-align: left;">Ambiente</th>
                <th style="padding: 12px; text-align: center;">m¬≤</th>
                <th style="padding: 12px; text-align: center;">Valor/m¬≤</th>
                <th style="padding: 12px; text-align: center;">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              ${data.envs.map(env => {
                const m2 = (env.w * env.l).toFixed(2);
                const subtotal = (m2 * data.unitPrice).toFixed(2);
                return `
                  <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 12px;">${getEmoji(env.type)} ${env.name}</td>
                    <td style="padding: 12px; text-align: center;">${m2}</td>
                    <td style="padding: 12px; text-align: center;">R$ ${data.unitPrice.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">R$ ${subtotal}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 8px; text-align: center;">
            <h2 style="margin: 0 0 10px 0;">üìä Total: ${totalM2.toFixed(2)} m¬≤</h2>
            <h1 style="margin: 0;">üíé Valor Total: R$ ${totalValue.toFixed(2)}</h1>
          </div>
          
          <!-- DATA NO RODAP√â DO CLIENTE -->
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: center; font-size: 12px; color: #5f7c8a">
            Data de emiss√£o: <strong>${data.date}</strong>
          </div>
          
          <div style="margin-top: 30px; text-align: center;">
            <a href="https://wa.me/55${data.company.phone.replace(/\D/g, '')}?text=Ol√°! Gostaria de conversar sobre o or√ßamento" 
               style="display: inline-block; background: #25D366; color: white; padding: 15px 25px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px;">
              üí¨ Falar no WhatsApp
            </a>
            <button onclick="window.print()" style="background: #3498db; color: white; border: none; padding: 15px 25px; border-radius: 8px; font-weight: bold; margin: 10px; cursor: pointer;">
              üñ®Ô∏è Imprimir Or√ßamento
            </button>
          </div>
        </div>
      `;
    }

    function getEmoji(type) {
      const emojis = {
        'Quarto': 'üõèÔ∏è',
        'Sala': 'üõãÔ∏è',
        'Cozinha': 'üç≥',
        'Banheiro': 'üöΩ',
        'Corredor': 'üö∂'
      };
      return emojis[type] || 'üè†';
    }

    // Inicializar
    if (!checkViewMode()) {
      // Modo normal de edi√ß√£o
      renderEnvList(); 
      syncPreview();
      loadSavedLogo(); // Carregar logo salvo ao iniciar
      setInterval(syncPreview, 700);
    }
  </script>
</body>
</html>