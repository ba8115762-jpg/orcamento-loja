<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de OrÃ§amento Profissional</title>
  <meta name="description" content="Calcula mÂ² por ambiente, soma, gera orÃ§amento visual e envia por WhatsApp" />
  <style>
    :root{
      --bg:#071023; --card:#07172b; --panel:#0b2233; --accent:#06b6d4; --accent-2:#7c3aed; --muted:#9fb3c8; --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:linear-gradient(180deg,#031026 0%, #061229 60%);color:#e6eef8;min-height:100vh;padding:20px}

    .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:minmax(300px, 400px) 1fr;gap:20px}
    .panel{background:linear-gradient(180deg,var(--card),#031228);border-radius:var(--radius);padding:18px;box-shadow:0 8px 40px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}

    h1{font-size:18px;margin:0 0 8px 0;display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:13px}

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text], input[type=number], input[type=date], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;font-size:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .env-list{display:flex;flex-direction:column;gap:10px;max-height:320px;overflow:auto;padding-right:6px;margin-top:8px}
    .env{display:flex;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));align-items:center}
    .env .meta{flex:1}
    .env .meta small{display:block;color:var(--muted);font-size:12px}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;color:white;cursor:pointer;font-weight:700;font-size:14px;white-space:nowrap}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn.success{background:linear-gradient(90deg,#10b981,#059669)}

    .preview{padding:20px;min-height:540px;overflow:auto}
    .invoice{background:linear-gradient(180deg,#e9f6fb,#f6fbff);color:#071726;padding:18px;border-radius:12px;border:1px solid rgba(2,6,23,0.06);min-width:280px}

    .invoice header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:66px;height:66px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:white;overflow:hidden;position:relative;flex-shrink:0}
    .logo img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .companyTitle{font-weight:800}
    .companyMeta{font-size:13px;color:#254254}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:white}
    th,td{padding:10px;text-align:left;border-bottom:1px dashed rgba(0,0,0,0.06);font-size:13px}
    th{color:#355a70;background:#f1f7fb;font-weight:700}
    td.right{text-align:right}

    .total{display:flex;justify-content:flex-end;margin-top:14px;font-weight:700}
    .images-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .thumb{width:96px;height:64px;border-radius:8px;background:#eef7fb;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(0,0,0,0.06);flex-shrink:0}
    .small{font-size:12px;color:#5f7c8a}

    footer.app-actions{display:flex;gap:10px;justify-content:space-between;margin-top:12px;flex-wrap:wrap}

    /* Modal para o Link */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal-content{background:var(--card);padding:30px;border-radius:20px;max-width:500px;width:100%;border:1px solid rgba(255,255,255,0.1)}
    .link-display{background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin:15px 0;word-break:break-all;border:1px solid var(--accent)}

    /* ConfiguraÃ§Ã£o do Logo */
    .logo-config{background:rgba(255,255,255,0.02);padding:15px;border-radius:10px;margin-bottom:15px;border:1px dashed rgba(255,255,255,0.1)}
    
    /* CORREÃ‡ÃƒO PARA OS SELECTS - TEXTO VISÃVEL */
    select {
        color: #e6eef8 !important;
        background: var(--panel) !important;
    }

    select option {
        background: var(--panel) !important;
        color: #e6eef8 !important;
        padding: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    select:focus {
        background: var(--panel) !important;
        color: #e6eef8 !important;
    }

    /* Responsividade */
    @media (max-width: 1024px) {
      .wrap{grid-template-columns:1fr;gap:15px}
      .panel{padding:15px}
      .preview{padding:15px}
    }
    
    @media (max-width: 768px) {
      body{padding:10px}
      .row{flex-direction:column}
      .invoice header{flex-direction:column;text-align:center}
      .brand{justify-content:center;text-align:center}
      footer.app-actions{flex-direction:column}
      .btn{width:100%;justify-content:center}
      .preview-actions{flex-direction:column;gap:10px}
      .preview-actions > div{width:100%}
    }
    
    @media (max-width: 480px) {
      .panel{padding:12px}
      .preview{padding:12px}
      .invoice{padding:12px}
      .env{flex-direction:column;align-items:flex-start}
      .env .actions{width:100%;justify-content:space-between}
      .logo{width:50px;height:50px;font-size:14px}
    }

    /* Preview actions */
    .preview-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    
    /* Cliente View */
    .client-view{display:none;max-width:800px;margin:0 auto;padding:20px}
    .client-budget{background:white;color:#333;border-radius:12px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}

    /* Novo BotÃ£o */
    .new-budget-btn{background:linear-gradient(90deg,#f59e0b,#d97706) !important}
  </style>
</head>
<body>
  <!-- Modo EdiÃ§Ã£o -->
  <div id="editorView">
    <div class="wrap">
      <div class="panel">
        <h1>ğŸ”§ Sistema de OrÃ§amento <span class="muted">(mÂ² por ambiente)</span></h1>
        <p class="muted">Adicione ambientes com largura x comprimento (m). O sistema calcula mÂ², totaliza, gera preview estilizado e envia por WhatsApp.</p>

        <!-- CONFIGURAÃ‡ÃƒO DO LOGO -->
        <div class="logo-config">
          <label><strong>ğŸ“· Logo da Sua Empresa</strong></label>
          <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
            <div class="logo">
              <img id="logoImg" src="" alt="Logo" style="display:none"/>
              <div id="logoPlaceholder" style="font-size:12px;text-align:center">Seu Logo</div>
            </div>
            <div style="flex:1">
              <label class="btn ghost" style="width:100%;text-align:center;margin-bottom:5px">
                ğŸ“ Escolher Logo
                <input id="uploadCompanyLogo" type="file" accept="image/*" style="display:none"/>
              </label>
              <button id="removeLogo" class="btn danger small" style="width:100%;display:none">
                ğŸ—‘ï¸ Remover Logo
              </button>
              <div class="muted" style="font-size:11px;margin-top:5px">PNG, JPG atÃ© 2MB</div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Nome da Loja</label>
          <input id="companyName" type="text" placeholder="Ex: Gesso Lucca - Especialistas" />
          <div class="row" style="margin-top:8px;">
            <input id="companyPhone" type="text" placeholder="Telefone da loja" />
            <input id="companyAddress" type="text" placeholder="EndereÃ§o da loja" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Dados do Cliente</label>
          <div class="row" style="margin-top:8px;">
            <input id="clientName" type="text" placeholder="Nome do cliente" />
            <input id="clientPhone" type="text" placeholder="Telefone do cliente" />
          </div>
          <input id="clientAddress" type="text" placeholder="EndereÃ§o do cliente" style="margin-top:8px;" />
          
          <div style="margin-top:12px">
            <label>Data do OrÃ§amento</label>
            <input id="budgetDate" type="date" style="margin-top:8px;" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Valor por mÂ² (R$)</label>
          <input id="unitPrice" type="number" step="0.01" placeholder="Ex: 150.00" />
        </div>

        <div style="margin-top:12px">
          <label>Tipo de serviÃ§o</label>
          <select id="serviceType">
            <option value="">Selecione o tipo de serviÃ§o</option>
            <option>InstalaÃ§Ã£o de gesso</option>
            <option>Acabamento simples</option>
            <option>Piso e azulejo</option>
            <option>Pintura</option>
            <option>Reforma completa</option>
            <option>Outro</option>
          </select>
          <input id="serviceNote" type="text" placeholder="ObservaÃ§Ã£o sobre o serviÃ§o (opcional)" style="margin-top:8px;" />
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.04);margin:14px 0" />

        <div>
          <label><strong>Adicionar Ambiente</strong></label>
          <div class="row">
            <select id="envType">
              <option>Quarto</option>
              <option>Sala</option>
              <option>Cozinha</option>
              <option>Banheiro</option>
              <option>Corredor</option>
              <option>Outro</option>
            </select>
            <input id="envName" type="text" placeholder="Nome (ex: Quarto 1)" />
          </div>
          <div class="row" style="margin-top:8px">
            <input id="envWidth" type="number" step="0.01" placeholder="Largura (m)" />
            <input id="envLength" type="number" step="0.01" placeholder="Comprimento (m)" />
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
            <button id="addEnv" class="btn">â• Adicionar ambiente</button>
            <button id="clearAll" class="btn ghost">Limpar tudo</button>
          </div>

          <div id="envList" class="env-list"></div>
        </div>

        <!-- BotÃ£o Novo OrÃ§amento -->
        <div style="margin-top:20px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1)">
          <button id="newBudget" class="btn new-budget-btn" style="width:100%">
            ğŸ†• Novo OrÃ§amento
          </button>
        </div>
      </div>

      <div class="panel preview">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:10px">
          <div>
            <strong>PrÃ©-visualizaÃ§Ã£o do OrÃ§amento</strong>
            <div class="small">Visual moderno â€” gere PNG para enviar ao cliente ou use Whatsapp direto.</div>
          </div>
          <div class="preview-actions">
            <button id="genPNG" class="btn ghost">â¬‡ï¸ PNG</button>
            <button id="sendWA" class="btn">ğŸ“² WhatsApp</button>
            <button id="genLink" class="btn success">ğŸ”— Link</button>
          </div>
        </div>

        <div id="invoice" class="invoice">
          <header>
            <div class="brand">
              <div class="logo" id="logoArea">
                <img id="previewLogoImg" src="" alt="logo" style="display:none"/>
                <div id="previewLogoPlaceholder" style="font-size:12px;text-align:center">Logo</div>
              </div>
              <div>
                <div class="companyTitle" id="companyTitle">Sua Empresa</div>
                <div class="companyMeta" id="companyMeta">â€”</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="small">OrÃ§amento</div>
              <div id="dateNow" style="font-weight:700">â€”</div>
            </div>
          </header>

          <div style="display:flex;justify-content:space-between;gap:20px;align-items:flex-start;flex-wrap:wrap">
            <div>
              <div class="small">Cliente</div>
              <div id="clientTitle" style="font-weight:700">â€”</div>
              <div class="companyMeta" id="clientMeta">â€”</div>
            </div>

            <div style="text-align:right">
              <div class="small">ServiÃ§o</div>
              <div id="serviceTitle" style="font-weight:700">â€”</div>
              <div class="small" id="serviceNotePreview"></div>
            </div>
          </div>

          <table id="itemsTable" aria-live="polite">
            <thead>
              <tr><th>Ambiente</th><th style="width:90px">mÂ²</th><th style="width:140px">Valor/mÂ²</th><th style="width:140px">Subtotal (R$)</th></tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="total">
            <div style="min-width:300px;">
              <div class="small">Total mÂ²: <span id="totalM2">0</span></div>
              <div class="small">Valor total (R$): <span id="totalValue">0,00</span></div>
            </div>
          </div>

          <div class="images-row" id="imagesRow"></div>

          <div style="margin-top:12px;font-size:13px;color:#37576b">ObservaÃ§Ãµes gerais: <span id="notesPreview">â€”</span></div>
          
          <div style="margin-top:20px;padding-top:10px;border-top:1px dashed #ccc;text-align:center;font-size:12px;color:#5f7c8a">
            Sistema criado por: Bruno Araujo Bonifacio â€¢ Data de emissÃ£o: <span id="invoiceDate">â€”</span>
          </div>
        </div>

        <footer class="app-actions">
          <div style="display:flex;gap:8px">
            <label class="btn ghost">ğŸ–¼ï¸ Imagens do serviÃ§o <input id="uploadImage" type="file" accept="image/*" style="display:none" multiple /></label>
          </div>
          <div style="display:flex;gap:8px">
            <button id="copySummary" class="btn ghost">ğŸ“‹ Copiar Texto</button>
          </div>
        </footer>
      </div>
    </div>
  </div>

  <!-- VisualizaÃ§Ã£o do Cliente -->
  <div id="clientView" class="client-view" style="display:none">
    <div class="client-budget" id="clientBudget">
      <!-- O conteÃºdo serÃ¡ gerado pelo JavaScript -->
    </div>
    <div style="text-align:center;margin-top:20px">
      <button id="backToEdit" class="btn">â† Voltar para EdiÃ§Ã£o</button>
    </div>
  </div>

  <!-- Modal para mostrar o link -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ”— Link do OrÃ§amento</h2>
      <p class="muted">Envie este link para seu cliente visualizar o orÃ§amento:</p>
      
      <div class="link-display" id="generatedLink">
        Carregando...
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
        <button class="btn" onclick="copyGeneratedLink()" style="flex:1">ğŸ“‹ Copiar Link</button>
        <button class="btn" onclick="openClientView()" style="flex:1;background:linear-gradient(90deg,#8b5cf6,#7c3aed)">ğŸ‘€ Visualizar</button>
        <button class="btn success" onclick="closeLinkModalAndNewBudget()" style="flex:1">ğŸ†• Novo OrÃ§amento</button>
        <button class="btn ghost" onclick="closeLinkModal()" style="flex:1">Fechar</button>
      </div>
      
      <div style="margin-top:15px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px">
        <small class="muted">ğŸ’¡ Dica: Este link funciona mesmo apÃ³s fechar a pÃ¡gina. Salve no seu sistema para acesso futuro.</small>
      </div>
    </div>
  </div>

  <script>
    // --- Data model ---
    const model = {envs:[], images:[], logo: null};
    const $ = id => document.getElementById(id);
    const fmt = v => Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    // FUNÃ‡Ã•ES PARA SALVAR E CARREGAR DADOS
    function saveBudgetData() {
      const budgetData = {
        companyName: $('companyName').value,
        companyPhone: $('companyPhone').value,
        companyAddress: $('companyAddress').value,
        clientName: $('clientName').value,
        clientPhone: $('clientPhone').value,
        clientAddress: $('clientAddress').value,
        budgetDate: $('budgetDate').value,
        unitPrice: $('unitPrice').value,
        serviceType: $('serviceType').value,
        serviceNote: $('serviceNote').value,
        envs: model.envs,
        images: model.images,
        logo: model.logo
      };
      localStorage.setItem('currentBudget', JSON.stringify(budgetData));
    }

    function loadBudgetData() {
      const saved = localStorage.getItem('currentBudget');
      if (saved) {
        const budgetData = JSON.parse(saved);
        
        $('companyName').value = budgetData.companyName || '';
        $('companyPhone').value = budgetData.companyPhone || '';
        $('companyAddress').value = budgetData.companyAddress || '';
        $('clientName').value = budgetData.clientName || '';
        $('clientPhone').value = budgetData.clientPhone || '';
        $('clientAddress').value = budgetData.clientAddress || '';
        $('budgetDate').value = budgetData.budgetDate || '';
        $('unitPrice').value = budgetData.unitPrice || '';
        $('serviceType').value = budgetData.serviceType || '';
        $('serviceNote').value = budgetData.serviceNote || '';
        
        model.envs = budgetData.envs || [];
        model.images = budgetData.images || [];
        model.logo = budgetData.logo || null;
        
        return true;
      }
      return false;
    }

    function clearSavedBudget() {
      localStorage.removeItem('currentBudget');
    }

    // FUNÃ‡ÃƒO PARA INICIALIZAR DATA - CORRIGIDA
    function initializeDate() {
      const today = new Date();
      
      // CORREÃ‡ÃƒO: Ajusta o fuso horÃ¡rio para o Brasil
      const timezoneOffset = today.getTimezoneOffset() * 60000; // offset em milissegundos
      const localDate = new Date(today.getTime() - timezoneOffset);
      const formattedDate = localDate.toISOString().split('T')[0];
      
      // SÃ³ define a data se nÃ£o houver uma data jÃ¡ selecionada
      if (!$('budgetDate').value) {
        $('budgetDate').value = formattedDate;
      }
      
      // Atualiza a exibiÃ§Ã£o com a data atual do campo
      updateDateDisplay();
    }

    // FUNÃ‡ÃƒO PARA ATUALIZAR A EXIBIÃ‡ÃƒO DA DATA - CORRIGIDA
    function updateDateDisplay() {
      const selectedDate = new Date($('budgetDate').value);
      
      // CORREÃ‡ÃƒO: Ajusta o fuso horÃ¡rio para exibiÃ§Ã£o correta
      const timezoneOffset = selectedDate.getTimezoneOffset() * 60000;
      const localDate = new Date(selectedDate.getTime() + timezoneOffset);
      
      const displayDate = localDate.toLocaleDateString('pt-BR');
      $('dateNow').textContent = displayDate;
      $('invoiceDate').textContent = displayDate;
    }

    // FUNÃ‡ÃƒO PARA LIMPAR CAMPOS DO ORÃ‡AMENTO (APENAS QUANDO SOLICITADO)
    function clearBudgetFields() {
      if(confirm('Tem certeza que deseja limpar todos os dados do orÃ§amento atual? Isso nÃ£o afetarÃ¡ os dados da loja.')) {
        // Limpar dados do cliente
        $('clientName').value = '';
        $('clientPhone').value = '';
        $('clientAddress').value = '';
        
        // Limpar serviÃ§o
        $('serviceType').selectedIndex = 0;
        $('serviceNote').value = '';
        
        // Limpar valor por mÂ²
        $('unitPrice').value = '';
        
        // Limpar ambientes
        model.envs = [];
        
        // Limpar imagens
        model.images = [];
        
        // Limpar dados salvos
        clearSavedBudget();
        
        // Atualizar data atual
        initializeDate();
        
        // Atualizar interface
        renderEnvList();
        syncPreview();
        
        // Mostrar mensagem de confirmaÃ§Ã£o
        showNotification('Campos limpos! Pronto para novo orÃ§amento.', 'success');
      }
    }

    // FUNÃ‡ÃƒO PARA LIMPAR TUDO (INCLUINDO DADOS DA LOJA)
    function clearAllData() {
      if(confirm('Tem certeza que deseja limpar TODOS os dados, incluindo dados da loja?')) {
        // Limpar dados da loja
        $('companyName').value = '';
        $('companyPhone').value = '';
        $('companyAddress').value = '';
        
        // Limpar logo
        model.logo = null;
        localStorage.removeItem('companyLogo');
        updateLogoDisplay();
        
        // Limpar dados do orÃ§amento
        $('clientName').value = '';
        $('clientPhone').value = '';
        $('clientAddress').value = '';
        $('serviceType').selectedIndex = 0;
        $('serviceNote').value = '';
        $('unitPrice').value = '';
        model.envs = [];
        model.images = [];
        
        // Limpar dados salvos
        clearSavedBudget();
        
        // Atualizar data
        initializeDate();
        
        // Atualizar interface
        renderEnvList();
        syncPreview();
        
        showNotification('Todos os dados foram limpos!', 'success');
      }
    }

    // FUNÃ‡ÃƒO PARA LIMPAR APÃ“S ENVIO/DOWNLOAD (SEM CONFIRMAÃ‡ÃƒO)
    function clearAfterAction() {
      // Limpar dados do cliente
      $('clientName').value = '';
      $('clientPhone').value = '';
      $('clientAddress').value = '';
      
      // Limpar serviÃ§o
      $('serviceType').selectedIndex = 0;
      $('serviceNote').value = '';
      
      // Limpar valor por mÂ²
      $('unitPrice').value = '';
      
      // Limpar ambientes
      model.envs = [];
      
      // Limpar imagens
      model.images = [];
      
      // Limpar dados salvos
      clearSavedBudget();
      
      // Atualizar data atual
      initializeDate();
      
      // Atualizar interface
      renderEnvList();
      syncPreview();
    }

    // FUNÃ‡ÃƒO PARA MOSTRAR NOTIFICAÃ‡ÃƒO
    function showNotification(message, type = 'info') {
      // Criar elemento de notificaÃ§Ã£o
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 300px;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remover apÃ³s 3 segundos
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Adicionar animaÃ§Ãµes CSS para notificaÃ§Ãµes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // FUNÃ‡Ã•ES DO LOGO
    function loadSavedLogo() {
      const savedLogo = localStorage.getItem('companyLogo');
      if (savedLogo) {
        model.logo = savedLogo;
        updateLogoDisplay();
      }
    }

    function updateLogoDisplay() {
      if (model.logo) {
        $('logoImg').src = model.logo;
        $('logoImg').style.display = 'block';
        $('logoPlaceholder').style.display = 'none';
        $('removeLogo').style.display = 'block';
        
        $('previewLogoImg').src = model.logo;
        $('previewLogoImg').style.display = 'block';
        $('previewLogoPlaceholder').style.display = 'none';
      } else {
        $('logoImg').style.display = 'none';
        $('logoPlaceholder').style.display = 'block';
        $('removeLogo').style.display = 'none';
        
        $('previewLogoImg').style.display = 'none';
        $('previewLogoPlaceholder').style.display = 'block';
      }
    }

    // FUNÃ‡Ã•ES PRINCIPAIS
    function renderEnvList(){
      const list = $('envList'); list.innerHTML='';
      model.envs.forEach((e,idx)=>{
        const el = document.createElement('div'); el.className='env';
        el.innerHTML = `
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:5px">
              <strong>${e.name} (${e.type})</strong>
              <div class="small">${(e.w*e.l).toFixed(2)} mÂ²</div>
            </div>
            <small>L:${e.w}m â€¢ C:${e.l}m â€¢ ServiÃ§o: ${e.service||'â€”'}</small>
          </div>
          <div class="actions" style="display:flex;gap:6px;align-items:center">
            <button class="btn ghost small" onclick="editEnv(${idx})">âœï¸</button>
            <button class="btn danger small" onclick="removeEnv(${idx})">ğŸ—‘ï¸</button>
          </div>`;
        list.appendChild(el);
      });
    }

    function syncPreview(){
      $('companyTitle').innerText = $('companyName').value || 'Sua Empresa';
      $('companyMeta').innerText = `${$('companyPhone').value || 'â€”'} â€¢ ${$('companyAddress').value || 'â€”'}`;
      $('clientTitle').innerText = $('clientName').value || 'â€”';
      $('clientMeta').innerText = `${$('clientPhone').value || 'â€”'} â€¢ ${$('clientAddress').value || 'â€”'}`;
      $('serviceTitle').innerText = $('serviceType').value || 'â€”';
      $('serviceNotePreview').innerText = $('serviceNote').value || '';
      $('notesPreview').innerText = $('serviceNote').value || 'â€”';

      // CORREÃ‡ÃƒO: Usa a funÃ§Ã£o atualizada para exibir a data
      updateDateDisplay();

      const tbody = $('itemsTable').querySelector('tbody'); tbody.innerHTML='';
      const unit = parseFloat($('unitPrice').value) || 0;
      let totalM2 = 0, totalVal = 0;
      model.envs.forEach((e,idx)=>{
        const m2 = (Number(e.w||0)*Number(e.l||0));
        const sub = m2*unit;
        totalM2 += m2; totalVal += sub;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.name} â€” ${e.type}</td><td>${m2.toFixed(2)}</td><td>R$ ${fmt(unit)}</td><td>R$ ${fmt(sub)}</td>`;
        tbody.appendChild(tr);
      });
      $('totalM2').innerText = totalM2.toFixed(2);
      $('totalValue').innerText = fmt(totalVal);

      const imagesRow = $('imagesRow'); imagesRow.innerHTML='';
      (model.images||[]).forEach((src, i)=>{
        const d = document.createElement('div'); d.className='thumb'; d.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover"/>`;
        imagesRow.appendChild(d);
      });

      // Salva os dados sempre que a prÃ©via Ã© atualizada
      saveBudgetData();
    }

    // EVENT LISTENERS
    $('uploadCompanyLogo').addEventListener('change', function(ev) {
      const file = ev.target.files[0];
      if (!file) return;
      
      if (file.size > 2 * 1024 * 1024) {
        alert('âš ï¸ Arquivo muito grande! Escolha uma imagem menor que 2MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        model.logo = e.target.result;
        localStorage.setItem('companyLogo', model.logo);
        updateLogoDisplay();
        showNotification('Logo adicionado com sucesso!', 'success');
      };
      reader.readAsDataURL(file);
      ev.target.value = '';
    });

    $('removeLogo').addEventListener('click', function() {
      if (confirm('Tem certeza que deseja remover o logo?')) {
        model.logo = null;
        localStorage.removeItem('companyLogo');
        updateLogoDisplay();
        showNotification('Logo removido!', 'success');
      }
    });

    $('addEnv').addEventListener('click', ()=>{
      const type = $('envType').value;
      const name = $('envName').value || `${type} ${model.envs.length+1}`;
      const w = parseFloat($('envWidth').value);
      const l = parseFloat($('envLength').value);
      if(isNaN(w) || isNaN(l)) return alert('Preencha largura e comprimento vÃ¡lidos (em metros).');
      const service = $('serviceType').value;
      model.envs.push({type,name,w,l,service});
      $('envName').value=''; $('envWidth').value=''; $('envLength').value='';
      renderEnvList(); syncPreview();
    });

    function removeEnv(i){ if(!confirm('Remover ambiente?')) return; model.envs.splice(i,1); renderEnvList(); syncPreview(); }
    function editEnv(i){
      const e = model.envs[i];
      const name = prompt('Nome do ambiente:', e.name); if(name===null) return;
      const w = parseFloat(prompt('Largura (m):', e.w)); if(isNaN(w)) return alert('Largura invÃ¡lida');
      const l = parseFloat(prompt('Comprimento (m):', e.l)); if(isNaN(l)) return alert('Comprimento invÃ¡lido');
      model.envs[i] = {...e, name, w, l}; renderEnvList(); syncPreview();
    }

    $('clearAll').addEventListener('click', clearAllData);

    ['companyName','companyPhone','companyAddress','clientName','clientPhone','clientAddress','unitPrice','serviceType','serviceNote','budgetDate'].forEach(id=>{ 
      $(id).addEventListener('input',syncPreview); 
    });

    $('uploadImage').addEventListener('change', (ev)=>{
      const files = Array.from(ev.target.files);
      model.images = model.images || [];
      files.forEach(f=>{
        const reader = new FileReader();
        reader.onload = e => { model.images.push(e.target.result); syncPreview(); }
        reader.readAsDataURL(f);
      });
      ev.target.value='';
    });

    $('copySummary').addEventListener('click', ()=>{ 
      const txt = buildTextSummary();
      navigator.clipboard.writeText(txt).then(()=>{
        showNotification('Resumo copiado para a Ã¡rea de transferÃªncia!', 'success');
      }); 
    });

    // WHATSAPP E PNG
    $('sendWA').addEventListener('click', ()=>{
      // Validar campos obrigatÃ³rios
      if (!validateBudget()) return;
      
      const phone = prompt('NÃºmero do WhatsApp destino (ex: 5511999998888) â€” deixe em branco para abrir WhatsApp Web', $('clientPhone').value||'');
      const text = buildTextSummary();
      const url = `https://wa.me/${phone || ''}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
      
      // Limpar campos apÃ³s envio
      setTimeout(() => {
        if (confirm('OrÃ§amento enviado! Deseja limpar os campos para um novo orÃ§amento?')) {
          clearAfterAction();
        }
      }, 1000);
    });

    $('genPNG').addEventListener('click', async ()=>{
      // Validar campos obrigatÃ³rios
      if (!validateBudget()) return;
      
      if(typeof html2canvas === 'undefined'){
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.body.appendChild(s);
        s.onload = () => capture();
      } else capture();
      
      function capture(){
        const node = document.getElementById('invoice');
        html2canvas(node, {scale:2}).then(canvas=>{
          canvas.toBlob(blob=>{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'orcamento.png'; a.click(); URL.revokeObjectURL(url);
            showNotification('PNG gerado com sucesso!', 'success');
            
            // Limpar campos apÃ³s download
            setTimeout(() => {
              if (confirm('PNG salvo! Deseja limpar os campos para um novo orÃ§amento?')) {
                clearAfterAction();
              }
            }, 1000);
          }, 'image/png');
        });
      }
    });

    // VALIDAÃ‡ÃƒO DO ORÃ‡AMENTO
    function validateBudget() {
      if (!$('companyName').value) {
        alert('Por favor, preencha o nome da loja.');
        $('companyName').focus();
        return false;
      }
      if (!$('clientName').value) {
        alert('Por favor, preencha o nome do cliente.');
        $('clientName').focus();
        return false;
      }
      if (!parseFloat($('unitPrice').value)) {
        alert('Por favor, preencha o valor por mÂ².');
        $('unitPrice').focus();
        return false;
      }
      if (model.envs.length === 0) {
        alert('Por favor, adicione pelo menos um ambiente.');
        return false;
      }
      return true;
    }

    // SISTEMA DE LINK E VISUALIZAÃ‡ÃƒO DO CLIENTE
    function generateShareableLink() {
      // Validar campos obrigatÃ³rios
      if (!validateBudget()) return;
      
      // CORREÃ‡ÃƒO: Usa a data formatada corretamente
      updateDateDisplay();
      const displayDate = $('invoiceDate').textContent;
      
      const budgetData = {
        company: {
          name: $('companyName').value,
          phone: $('companyPhone').value,
          address: $('companyAddress').value
        },
        client: {
          name: $('clientName').value,
          phone: $('clientPhone').value,
          address: $('clientAddress').value
        },
        service: {
          type: $('serviceType').value,
          note: $('serviceNote').value
        },
        unitPrice: parseFloat($('unitPrice').value) || 0,
        envs: model.envs,
        logo: model.logo,
        date: displayDate
      };

      const jsonString = JSON.stringify(budgetData);
      const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
      const baseUrl = window.location.href.split('?')[0];
      const shareableUrl = `${baseUrl}?view=client&data=${base64Data}`;
      
      $('generatedLink').textContent = shareableUrl;
      showLinkModal();
      
      // Salvar no localStorage para acesso rÃ¡pido
      localStorage.setItem('lastBudgetLink', shareableUrl);
    }

    function showClientView() {
      $('editorView').style.display = 'none';
      $('clientView').style.display = 'block';
      renderClientView();
    }

    function renderClientView() {
      const clientBudget = $('clientBudget');
      const unit = parseFloat($('unitPrice').value) || 0;
      let totalM2 = 0, totalVal = 0;
      
      let itemsHTML = '';
      model.envs.forEach((e) => {
        const m2 = (Number(e.w||0)*Number(e.l||0));
        const sub = m2*unit;
        totalM2 += m2; totalVal += sub;
        itemsHTML += `
          <tr>
            <td>${e.name} â€” ${e.type}</td>
            <td>${m2.toFixed(2)}</td>
            <td>R$ ${fmt(unit)}</td>
            <td>R$ ${fmt(sub)}</td>
          </tr>
        `;
      });

      // CORREÃ‡ÃƒO: Usa a data formatada corretamente
      const displayDate = $('invoiceDate').textContent;

      clientBudget.innerHTML = `
        <div style="text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #f0f0f0">
          ${model.logo ? `<img src="${model.logo}" alt="Logo" style="height:80px;margin-bottom:15px;border-radius:8px">` : ''}
          <h1 style="color:#2c5aa0;margin:0">${$('companyName').value || 'Sua Empresa'}</h1>
          <p style="color:#666;margin:5px 0">${$('companyPhone').value || 'â€”'} â€¢ ${$('companyAddress').value || 'â€”'}</p>
          <h2 style="color:#333;margin:10px 0">ORÃ‡AMENTO</h2>
          <p style="color:#666;margin:0"><strong>Data:</strong> ${displayDate}</p>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px">
          <div>
            <h3 style="color:#2c5aa0;margin-bottom:10px">ğŸ‘¤ Cliente</h3>
            <p style="margin:5px 0"><strong>${$('clientName').value || 'â€”'}</strong></p>
            <p style="margin:5px 0;color:#666">${$('clientPhone').value || 'â€”'}</p>
            <p style="margin:5px 0;color:#666">${$('clientAddress').value || 'â€”'}</p>
          </div>
          <div>
            <h3 style="color:#2c5aa0;margin-bottom:10px">ğŸ”§ ServiÃ§o</h3>
            <p style="margin:5px 0"><strong>${$('serviceType').value}</strong></p>
            <p style="margin:5px 0;color:#666">${$('serviceNote').value || 'â€”'}</p>
          </div>
        </div>

        <table style="width:100%;border-collapse:collapse;margin:20px 0">
          <thead>
            <tr style="background:#2c5aa0;color:white">
              <th style="padding:12px;text-align:left">Ambiente</th>
              <th style="padding:12px;text-align:center">mÂ²</th>
              <th style="padding:12px;text-align:center">Valor/mÂ²</th>
              <th style="padding:12px;text-align:center">Subtotal (R$)</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>

        <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-top:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
            <div>
              <h3 style="margin:0;color:#2c5aa0">Total do OrÃ§amento</h3>
              <p style="margin:5px 0;color:#666">${totalM2.toFixed(2)} mÂ² totais</p>
            </div>
            <div style="text-align:right">
              <h2 style="margin:0;color:#27ae60;font-size:28px">R$ ${fmt(totalVal)}</h2>
            </div>
          </div>
        </div>

        <div style="margin-top:30px;padding-top:20px;border-top:1px dashed #ccc;text-align:center">
          <p style="color:#666;margin:0">Este orÃ§amento foi gerado em ${displayDate}</p>
          <p style="color:#999;font-size:12px;margin:10px 0">Sistema desenvolvido por Bruno Araujo Bonifacio</p>
        </div>
      `;
    }

    function showLinkModal() {
      $('linkModal').style.display = 'flex';
    }
    
    function closeLinkModal() {
      $('linkModal').style.display = 'none';
    }

    function closeLinkModalAndNewBudget() {
      closeLinkModal();
      setTimeout(() => {
        clearAfterAction();
      }, 300);
    }
    
    function copyGeneratedLink() {
      const linkText = $('generatedLink').textContent;
      navigator.clipboard.writeText(linkText).then(() => {
        showNotification('âœ… Link copiado para a Ã¡rea de transferÃªncia!', 'success');
      });
    }

    function openClientView() {
      closeLinkModal();
      showClientView();
    }

    // VERIFICAR PARÃ‚METROS DA URL
    function checkViewMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const viewMode = urlParams.get('view');
      const dataParam = urlParams.get('data');
      
      if (viewMode === 'client' && dataParam) {
        try {
          const jsonString = decodeURIComponent(escape(atob(dataParam)));
          const budgetData = JSON.parse(jsonString);
          loadBudgetDataFromURL(budgetData);
          showClientView();
          return true;
        } catch (e) {
          console.error('Erro ao carregar dados do orÃ§amento:', e);
        }
      }
      return false;
    }

    function loadBudgetDataFromURL(data) {
      if (data.company) {
        $('companyName').value = data.company.name || '';
        $('companyPhone').value = data.company.phone || '';
        $('companyAddress').value = data.company.address || '';
      }
      if (data.client) {
        $('clientName').value = data.client.name || '';
        $('clientPhone').value = data.client.phone || '';
        $('clientAddress').value = data.client.address || '';
      }
      if (data.service) {
        $('serviceType').value = data.service.type || '';
        $('serviceNote').value = data.service.note || '';
      }
      if (data.unitPrice) $('unitPrice').value = data.unitPrice;
      if (data.envs) model.envs = data.envs;
      if (data.logo) {
        model.logo = data.logo;
        updateLogoDisplay();
      }
      if (data.date) {
        // CORREÃ‡ÃƒO: Carrega a data do orÃ§amento salvo
        $('budgetDate').value = data.date;
      }
      
      renderEnvList();
      syncPreview();
    }

    function buildTextSummary(){
      const unit = Number($('unitPrice').value||0);
      // CORREÃ‡ÃƒO: Usa a data formatada corretamente
      const displayDate = $('invoiceDate').textContent;
      
      let lines = [];
      lines.push(`${$('companyName').value || 'Loja'} â€” OrÃ§amento`);
      lines.push(`Data: ${displayDate}`);
      lines.push(`Cliente: ${$('clientName').value || '-'} | Tel: ${$('clientPhone').value || '-'}`);
      lines.push(`End.: ${$('clientAddress').value || '-'}`);
      lines.push(`ServiÃ§o: ${$('serviceType').value} ${$('serviceNote').value?'- '+$('serviceNote').value:''}`);
      lines.push('Ambientes:');
      let totalM2=0,total=0;
      model.envs.forEach(e=>{
        const m2 = Number(e.w)*Number(e.l); const sub = m2*unit; totalM2+=m2; total+=sub;
        lines.push(`- ${e.name} (${e.type}): ${m2.toFixed(2)} mÂ² x R$ ${unit.toFixed(2)} = R$ ${sub.toFixed(2)}`);
      });
      lines.push(`Total mÂ²: ${totalM2.toFixed(2)} mÂ²`);
      lines.push(`Valor total: R$ ${total.toFixed(2)}`);
      lines.push('Atenciosamente,');
      lines.push(`${$('companyName').value || '-'} | ${$('companyPhone').value || '-'}`);
      return lines.join('\n');
    }

    // INICIALIZAÃ‡ÃƒO
    $('genLink').addEventListener('click', generateShareableLink);
    $('newBudget').addEventListener('click', clearBudgetFields);
    $('backToEdit').addEventListener('click', () => {
      $('clientView').style.display = 'none';
      $('editorView').style.display = 'block';
    });

    // Inicializar carregando dados salvos
    setTimeout(() => {
      // Tenta carregar dados salvos primeiro
      const hasSavedData = loadBudgetData();
      
      // Se nÃ£o hÃ¡ dados salvos, inicializa vazio
      if (!hasSavedData) {
        model.envs = [];
      }
      
      renderEnvList(); 
      syncPreview();
      loadSavedLogo();
      initializeDate();
      
      if (!checkViewMode()) {
        // Modo normal - mantÃ©m os dados existentes
      }
    }, 100);

    // Salva os dados automaticamente a cada 2 segundos
    setInterval(() => {
      saveBudgetData();
    }, 2000);
  </script>
</body>
</html>
